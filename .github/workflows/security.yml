name: ä¾èµ–æ£€æŸ¥å’Œå®‰å…¨æ‰«æ

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 6 * * 1'  # æ¯å‘¨ä¸€æ—©ä¸Š6ç‚¹è¿è¡Œ

jobs:
  dependency-analysis:
    name: ä¾èµ–åˆ†æ
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: stable

      - name: è·å–ä¾èµ–
        run: flutter pub get

      - name: æ£€æŸ¥ä¾èµ–ç‰ˆæœ¬
        run: flutter pub outdated --mode=null-safety

      - name: ä¾èµ–éªŒè¯
        run: flutter pub run dependency_validator

      - name: æ£€æŸ¥ä¾èµ–è®¸å¯è¯
        run: flutter pub run license_checker

  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: stable

      - name: è·å–ä¾èµ–
        run: flutter pub get

      - name: è¿è¡Œ pana åˆ†æ
        run: dart pub run pana:analyze

      - name: æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ•æ„Ÿä¿¡æ¯æ³„éœ²
          dart pub global activate dart_pre_commit
          dart pub global run dart_pre_commit:check_secrets

      - name: ä»£ç å®‰å…¨åˆ†æ
        run: flutter pub run dart_code_metrics:metrics analyze lib --report-security

  license-compliance:
    name: è®¸å¯è¯åˆè§„æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: stable

      - name: è·å–ä¾èµ–
        run: flutter pub get

      - name: ç”Ÿæˆè®¸å¯è¯æŠ¥å‘Š
        run: flutter pub run licenses:report

      - name: æ£€æŸ¥è®¸å¯è¯åˆè§„æ€§
        run: |
          dart pub global activate license_checker
          dart pub global run license_checker:check

      - name: ä¸Šä¼ è®¸å¯è¯æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: license-report
          path: license_report.json

  vulnerability-scan:
    name: æ¼æ´æ‰«æ
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: stable

      - name: è·å–ä¾èµ–
        run: flutter pub get

      - name: è¿è¡Œä¾èµ–æ¼æ´æ‰«æ
        run: |
          dart pub global activate vulnerability_scanner
          dart pub global run vulnerability_scanner:scan

      - name: ç”Ÿæˆæ¼æ´æŠ¥å‘Š
        run: dart tool/generate_vulnerability_report.dart

      - name: ä¸Šä¼ æ¼æ´æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: vulnerability-report
          path: vulnerability_report.json

  generate-report:
    name: ç”Ÿæˆç»¼åˆæŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [dependency-analysis, security-scan, license-compliance, vulnerability-scan]
    if: always()
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š
        uses: actions/download-artifact@v3

      - name: ç”Ÿæˆç»¼åˆå®‰å…¨æŠ¥å‘Š
        run: |
          echo "# ä¾èµ–å’Œå®‰å…¨æ£€æŸ¥æŠ¥å‘Š" > SECURITY_REPORT.md
          echo "## ç”Ÿæˆæ—¶é—´: $(date)" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          
          echo "### ä¾èµ–åˆ†æ" >> SECURITY_REPORT.md
          if [ -f "dependency-analysis/report.json" ]; then
            echo "âœ… ä¾èµ–åˆ†æå®Œæˆ" >> SECURITY_REPORT.md
          else
            echo "âŒ ä¾èµ–åˆ†æå¤±è´¥" >> SECURITY_REPORT.md
          fi
          
          echo "### å®‰å…¨æ‰«æ" >> SECURITY_REPORT.md
          if [ -f "security-scan/report.json" ]; then
            echo "âœ… å®‰å…¨æ‰«æå®Œæˆ" >> SECURITY_REPORT.md
          else
            echo "âŒ å®‰å…¨æ‰«æå¤±è´¥" >> SECURITY_REPORT.md
          fi
          
          echo "### è®¸å¯è¯åˆè§„" >> SECURITY_REPORT.md
          if [ -f "license-report/license_report.json" ]; then
            echo "âœ… è®¸å¯è¯æ£€æŸ¥å®Œæˆ" >> SECURITY_REPORT.md
          else
            echo "âŒ è®¸å¯è¯æ£€æŸ¥å¤±è´¥" >> SECURITY_REPORT.md
          fi
          
          echo "### æ¼æ´æ‰«æ" >> SECURITY_REPORT.md
          if [ -f "vulnerability-report/vulnerability_report.json" ]; then
            echo "âœ… æ¼æ´æ‰«æå®Œæˆ" >> SECURITY_REPORT.md
          else
            echo "âŒ æ¼æ´æ‰«æå¤±è´¥" >> SECURITY_REPORT.md
          fi

      - name: ä¸Šä¼ ç»¼åˆæŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: comprehensive-security-report
          path: SECURITY_REPORT.md

  notify-issues:
    name: é—®é¢˜é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [generate-report]
    if: failure()
    steps:
      - name: å‘é€å®‰å…¨æ£€æŸ¥å¤±è´¥é€šçŸ¥
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: 'ğŸš¨ å®‰å…¨æ£€æŸ¥å¤±è´¥ï¼'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: åˆ›å»ºå®‰å…¨é—®é¢˜
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const { sha } = context;
            
            await github.rest.issues.create({
              owner,
              repo,
              title: 'ğŸ”’ å®‰å…¨æ£€æŸ¥å¤±è´¥',
              body: `å®‰å…¨æ£€æŸ¥è¿‡ç¨‹ä¸­å‘ç°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹å®‰å…¨æŠ¥å‘Šå¹¶å¤„ç†ã€‚\n\næäº¤: ${sha}\næ—¶é—´: ${new Date().toISOString()}`,
              labels: ['security', 'needs-attention', 'urgent'],
            });