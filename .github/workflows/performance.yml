name: æ€§èƒ½æµ‹è¯•

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ

jobs:
  performance-benchmark:
    name: æ€§èƒ½åŸºå‡†æµ‹è¯•
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        flutter-version: ['3.19.0', '3.18.0-0.5.pre']
      fail-fast: false

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.flutter-version }}
          channel: stable

      - name: è·å–ä¾èµ–
        run: flutter pub get

      
      - name: è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
        run: dart tool/performance.dart

      - name: ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
        run: |
          dart pub global activate benchmark_harness
          dart tool/performance_benchmark.dart > performance_results.json

      - name: ä¸Šä¼ æ€§èƒ½ç»“æœ
        uses: actions/upload-artifact@v3
        with:
          name: performance-results-${{ matrix.os }}-${{ matrix.flutter-version }}
          path: performance_results.json

  memory-usage:
    name: å†…å­˜ä½¿ç”¨æµ‹è¯•
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: stable

      - name: è·å–ä¾èµ–
        run: flutter pub get

      - name: è¿è¡Œå†…å­˜ä½¿ç”¨æµ‹è¯•
        run: |
          flutter test test/performance/memory_usage_test.dart --reporter=expanded

      - name: åˆ†æå†…å­˜ä½¿ç”¨æŠ¥å‘Š
        run: |
          dart tool/analyze_memory_usage.dart

      - name: ä¸Šä¼ å†…å­˜ä½¿ç”¨æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: memory-usage-report
          path: memory_usage_report.json

  render-performance:
    name: æ¸²æŸ“æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: stable

      - name: è·å–ä¾èµ–
        run: flutter pub get

      - name: è¿è¡Œæ¸²æŸ“æ€§èƒ½æµ‹è¯•
        run: |
          flutter drive --target=test/performance/render_performance_test.dart

      - name: åˆ†ææ¸²æŸ“æ€§èƒ½
        run: |
          dart tool/analyze_render_performance.dart

      - name: ä¸Šä¼ æ¸²æŸ“æ€§èƒ½æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: render-performance-report
          path: render_performance_report.json

  widget-benchmark:
    name: ç»„ä»¶æ€§èƒ½åŸºå‡†æµ‹è¯•
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: stable

      - name: è·å–ä¾èµ–
        run: flutter pub get

      - name: è¿è¡Œç»„ä»¶æ€§èƒ½æµ‹è¯•
        run: |
          flutter test test/performance/widget_benchmark_test.dart --reporter=expanded

      - name: ç”Ÿæˆç»„ä»¶æ€§èƒ½æŠ¥å‘Š
        run: |
          dart tool/generate_widget_benchmark_report.dart

      - name: ä¸Šä¼ ç»„ä»¶æ€§èƒ½æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: widget-benchmark-report
          path: widget_benchmark_report.json

  comparison-with-baseline:
    name: æ€§èƒ½åŸºå‡†å¯¹æ¯”
    runs-on: ubuntu-latest
    needs: [performance-benchmark, memory-usage, render-performance, widget-benchmark]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æ€§èƒ½æŠ¥å‘Š
        uses: actions/download-artifact@v3

      - name: ä¸åŸºå‡†æ€§èƒ½å¯¹æ¯”
        run: |
          dart tool/compare_performance_baseline.dart

      - name: ç”Ÿæˆæ€§èƒ½å¯¹æ¯”æŠ¥å‘Š
        run: |
          echo "# æ€§èƒ½å¯¹æ¯”æŠ¥å‘Š" > PERFORMANCE_COMPARISON.md
          echo "## ç”Ÿæˆæ—¶é—´: $(date)" >> PERFORMANCE_COMPARISON.md
          echo "" >> PERFORMANCE_COMPARISON.md
          echo "### ä¸åŸºå‡†æ€§èƒ½å¯¹æ¯”ç»“æœ" >> PERFORMANCE_COMPARISON.md
          echo "" >> PERFORMANCE_COMPARISON.md
          
          if [ -f "performance_comparison.json" ]; then
            dart tool/format_performance_comparison.dart >> PERFORMANCE_COMPARISON.md
          fi

      - name: ä¸Šä¼ æ€§èƒ½å¯¹æ¯”æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: performance-comparison-report
          path: |
            PERFORMANCE_COMPARISON.md
            performance_comparison.json

      - name: æ€§èƒ½é™çº§æ£€æŸ¥
        run: |
          dart tool/check_performance_regression.dart
        continue-on-error: true

  performance-dashboard:
    name: æ€§èƒ½ä»ªè¡¨æ¿æ›´æ–°
    runs-on: ubuntu-latest
    needs: [comparison-with-baseline]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ€§èƒ½å¯¹æ¯”æŠ¥å‘Š
        uses: actions/download-artifact@v3
        with:
          name: performance-comparison-report

      - name: æ›´æ–°æ€§èƒ½ä»ªè¡¨æ¿
        run: |
          dart tool/update_performance_dashboard.dart

      - name: éƒ¨ç½²æ€§èƒ½ä»ªè¡¨æ¿
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./performance_dashboard
          destination_dir: performance

  notify-performance-issues:
    name: æ€§èƒ½é—®é¢˜é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [comparison-with-baseline]
    if: failure()
    steps:
      - name: å‘é€æ€§èƒ½é™çº§é€šçŸ¥
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: 'âš ï¸ æ£€æµ‹åˆ°æ€§èƒ½é™çº§ï¼'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: åˆ›å»ºæ€§èƒ½é—®é¢˜
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const { sha } = context;
            
            await github.rest.issues.create({
              owner,
              repo,
              title: 'ğŸš¨ æ€§èƒ½é™çº§æ£€æµ‹',
              body: `æ£€æµ‹åˆ°æ€§èƒ½é™çº§ï¼Œè¯·æŸ¥çœ‹æ€§èƒ½æŠ¥å‘Šå¹¶ä¼˜åŒ–ã€‚\n\næäº¤: ${sha}\næ—¶é—´: ${new Date().toISOString()}`,
              labels: ['performance', 'regression', 'needs-attention'],
            });