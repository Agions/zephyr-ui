name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  FLUTTER_VERSION: '3.19.0'
  DART_VERSION: '3.3.0'
  PUB_CACHE_KEY: 'pub-cache-${{ hashFiles('pubspec.yaml') }}'
  MELOS_VERSION: '3.4.0'

jobs:
  analyze:
    name: ä»£ç åˆ†æ
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: è·å–ä¾èµ–
        run: |
          flutter pub get
          flutter pub deps

      - name: ä»£ç æ ¼å¼æ£€æŸ¥
        run: dart format --output=none --set-exit-if-changed .

      - name: é™æ€åˆ†æ
        run: flutter analyze --fatal-infos .

      - name: å¯¼å…¥é¡ºåºæ£€æŸ¥
        run: flutter pub run import_sorter:main --exit-if-changed

  test:
    name: æµ‹è¯•å¥—ä»¶
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        flutter-version: ['3.19.0', '3.18.0-0.5.pre']
      fail-fast: false

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.flutter-version }}
          channel: stable

      - name: ç¼“å­˜ Pub ä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.pub-cache
          key: ${{ env.PUB_CACHE_KEY }}

      - name: è·å–ä¾èµ–
        run: flutter pub get

      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: flutter test --coverage

      - name: è¿è¡Œé›†æˆæµ‹è¯•
        run: flutter test integration_test/

      - name: ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
        run: |
          dart pub global activate coverage
          dart pub global run coverage:format_coverage --lcov --in=coverage/lcov.info --out=coverage/lcovFormatted.info --packages=.dart_tool/package_config.json --report-on=lib/

      - name: ä¸Šä¼ è¦†ç›–ç‡åˆ° Codecov
        uses: codecov/codecov-action@v3
        with:
          files: coverage/lcovFormatted.info
          fail_ci_if_error: true

  build:
    name: æ„å»ºéªŒè¯
    runs-on: ${{ matrix.os }}
    needs: [analyze, test]
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        target: [apk, aab, ipa]
        exclude:
          - os: ubuntu-latest
            target: ipa
          - os: windows-latest
            target: apk
          - os: windows-latest
            target: aab
          - os: windows-latest
            target: ipa
          - os: macos-latest
            target: apk
          - os: macos-latest
            target: aab

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: è·å–ä¾èµ–
        run: flutter pub get

      - name: æ„å»ºç¤ºä¾‹åº”ç”¨
        run: |
          cd example
          flutter pub get
          flutter build ${{ matrix.target }} --release

  performance:
    name: æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [analyze, test]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: è·å–ä¾èµ–
        run: flutter pub get

      - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
        run: dart tool/performance.dart

      - name: ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
        run: dart pub global run dart_dev:performance

  security:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: [analyze, test]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: è·å–ä¾èµ–
        run: flutter pub get

      - name: ä¾èµ–å®‰å…¨æ‰«æ
        run: flutter pub run dependency_validator

      - name: ä»£ç å®‰å…¨æ‰«æ
        run: dart pub run dart_code_metrics:metrics analyze lib

  quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [analyze, test]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: è·å–ä¾èµ–
        run: flutter pub get

      - name: è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥
        run: dart analyze --fatal-infos .

      - name: æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡
        run: |
          dart pub global activate coverage
          dart pub global run coverage:test_with_coverage --min-coverage 80

  documentation:
    name: æ–‡æ¡£ç”Ÿæˆ
    runs-on: ubuntu-latest
    needs: [analyze, test, quality]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: è·å–ä¾èµ–
        run: flutter pub get

      - name: ç”Ÿæˆ API æ–‡æ¡£
        run: dart doc lib

      - name: éƒ¨ç½²æ–‡æ¡£åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./doc/api

  deploy:
    name: å‘å¸ƒéƒ¨ç½²
    runs-on: ubuntu-latest
    needs: [analyze, test, build, performance, security, quality, documentation]
    if: github.event_name == 'release' && github.event.action == 'published'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable

      - name: è·å–ä¾èµ–
        run: flutter pub get

      - name: å‘å¸ƒåˆ° pub.dev
        run: dart pub publish --force
        env:
          PUB_TOKEN: ${{ secrets.PUB_DEV_TOKEN }}


      - name: åˆ›å»ºå‘å¸ƒè¯´æ˜
        uses: actions/github-script@v6
        with:
          script: |
            const { tag_name, name, body } = context.payload.release;
            const { owner, repo } = context.repo;

            await github.rest.repos.createRelease({
              owner,
              repo,
              tag_name,
              name,
              body: `${body}\n\n## CI/CD Pipeline\n\nâœ… ä»£ç åˆ†æé€šè¿‡\nâœ… æµ‹è¯•å¥—ä»¶é€šè¿‡\nâœ… æ„å»ºéªŒè¯é€šè¿‡\nâœ… æ€§èƒ½æµ‹è¯•é€šè¿‡\nâœ… å®‰å…¨æ‰«æé€šè¿‡\nâœ… è´¨é‡æ£€æŸ¥é€šè¿‡\nâœ… æ–‡æ¡£ç”Ÿæˆå®Œæˆ`,
              draft: false,
              prerelease: false,
            });

  notify:
    name: é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    steps:
      - name: å‘é€æˆåŠŸé€šçŸ¥
        if: needs.deploy.result == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: 'ğŸ‰ chromaUI å‘å¸ƒæˆåŠŸï¼'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: å‘é€å¤±è´¥é€šçŸ¥
        if: needs.deploy.result == 'failure'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: 'âŒ chromaUI å‘å¸ƒå¤±è´¥ï¼'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
